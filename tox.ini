[tox]
skipsdist = True
envlist = coverage,check,docs,simple

[testenv]

basepython = python3.7

passenv=
    TOXENV
    CI
    CI_*
    CIRCLECI
    CIRCLE_*
    TRAVIS
    TRAVIS_*
    APPVEYOR
    APPVEYOR_*
    CODECOV_TOKEN

deps =
     -e .[dev]

[testenv:simple]
# To make sure that dev deps aren't required, we install only mario and try a
# simple command.
deps = {toxinidir}
commands =
         mario eval 1

[testenv:test]
commands =
   pytest --cov=mario --cov=tests {posargs}


[testenv:coverage]
commands =

   python -m site
   pytest --cov=mario --cov=tests {posargs}
   coverage report -m --fail-under=95
   cuv graph

[testenv:docshtest]
changedir={envtmpdir}
whitelist_externals = bash
commands=
        bash {toxinidir}/tests/find_broken_docshtests.bash {toxinidir}/README.rst
        docshtest {toxinidir}/README.rst

[testenv:check]
commands =
   python setup.py sdist bdist_wheel
   mypy src tests
   pylint src tests
   twine check dist/mario-*
   black --check src/ tests/
   tox -e docshtest
   pre-commit run -a

[testenv:codecov]
skip_install=True
deps=
    codecov
commands=
    python -c 'import sys; print(sys.version)'
    codecov


[testenv:doc]
deps =
     -r docs/requirements.txt

commands =
         {envbindir}/sphinx-apidoc -o docs/reference -f src
         {envbindir}/sphinx-build -E -b html docs dist/docs


[testenv:bump]
deps =
     bump2version
     pre-commit
     towncrier

passenv =
    GIT_AUTHOR_NAME
    GIT_AUTHOR_EMAIL
    GIT_COMMITTER_NAME
    GIT_COMMITTER_EMAIL

whitelist_externals =
    git
    bash

commands =
         pre-commit install --install-hooks
         pre-commit run -a
         bash ci/bump.bash

[testenv:release]
deps =
     twine

passenv =
        TWINE_USERNAME
        TWINE_PASSWORD

commands =
         rm -rf dist
         python setup.py sdist bdist_wheel
         twine upload --skip-existing dist/*
